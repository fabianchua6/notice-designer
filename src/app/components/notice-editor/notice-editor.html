<div class="editor-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <button mat-icon-button routerLink="/" matTooltip="Back to Dashboard">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>{{ isEditMode ? 'Edit Notice' : 'Create Notice' }}</h1>
        <p class="subtitle">{{ isEditMode ? 'Modify existing notice template' : 'Design a new notice template' }}</p>
      </div>
    </div>
    <div class="header-actions">
      <iras-button variant="tertiary" icon="receipt_long" [class.active]="showHeaderSettings" (click)="toggleHeaderSettings()">
        Header Settings
      </iras-button>
      <iras-button variant="tertiary" icon="widgets" [class.active]="showComponentsPanel" (click)="toggleComponentsPanel()">
        Components
      </iras-button>
      <iras-button variant="tertiary" icon="code" [class.active]="showVariablePanel" (click)="toggleVariablePanel()">
        Variables
      </iras-button>
      <iras-button variant="tertiary" icon="refresh" (click)="resetForm()">
        Reset
      </iras-button>
      <iras-button variant="tertiary" icon="bookmark" [disabled]="!title() || !content()" (click)="saveAsMasterTemplate()">
        Save as Template
      </iras-button>
      <iras-button variant="secondary" icon="print" [disabled]="!title() || !content()" (click)="printNotice()">
        Print / PDF
      </iras-button>
      <iras-button variant="primary" icon="save" [disabled]="!title() || !content()" (click)="saveNotice()">
        {{ isEditMode ? 'Update Notice' : 'Save Notice' }}
      </iras-button>
    </div>
  </div>

  <!-- Variable Panel (Collapsible) -->
  @if (showVariablePanel) {
    <div class="variable-panel">
      <div class="panel-header">
        <mat-icon>data_object</mat-icon>
        <span>Template Variables</span>
        <span class="hint">Click a variable to insert it into your content</span>
      </div>
      <div class="variable-categories">
        @for (category of variableCategories; track category) {
          <div class="variable-category">
            <h4>{{ category }}</h4>
            <div class="variable-chips">
              @for (variable of getVariablesByCategory(category); track variable.key) {
                <button 
                  mat-stroked-button 
                  class="variable-chip"
                  (click)="insertVariable(variable)"
                  [matTooltip]="'Sample: ' + variable.sampleValue">
                  <mat-icon>add</mat-icon>
                  {{ variable.label }}
                  <code>{{ variable.key }}</code>
                </button>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Header Settings Panel (Collapsible) -->
  @if (showHeaderSettings) {
    <div class="header-panel">
      <div class="panel-header">
        <mat-icon>receipt_long</mat-icon>
        <span>Letter Header Settings</span>
        <span class="hint">Configure the IRAS header section</span>
      </div>
      <div class="header-form">
        <div class="form-row">
          <mat-slide-toggle 
            [checked]="headerConfig().showHeader" 
            (change)="updateHeaderConfig('showHeader', $event.checked)">
            Show Header
          </mat-slide-toggle>
        </div>
        
        @if (headerConfig().showHeader) {
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Tax Reference Number</mat-label>
              <input matInput [value]="headerConfig().taxRef" (input)="updateHeaderConfig('taxRef', $any($event.target).value)">
              <mat-hint>Supports variables like {{'{{'}}taxpayer.taxRef{{'}}'}}</mat-hint>
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Date</mat-label>
              <input matInput [value]="headerConfig().date" (input)="updateHeaderConfig('date', $any($event.target).value)">
              <mat-hint>Format: DD Month YYYY</mat-hint>
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Recipient Name</mat-label>
              <input matInput [value]="headerConfig().recipientName" (input)="updateHeaderConfig('recipientName', $any($event.target).value)">
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Address Line 1</mat-label>
              <input matInput [value]="headerConfig().addressLine1" (input)="updateHeaderConfig('addressLine1', $any($event.target).value)">
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Address Line 2 (Optional)</mat-label>
              <input matInput [value]="headerConfig().addressLine2" (input)="updateHeaderConfig('addressLine2', $any($event.target).value)">
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Address Line 3 (Optional)</mat-label>
              <input matInput [value]="headerConfig().addressLine3" (input)="updateHeaderConfig('addressLine3', $any($event.target).value)">
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Address Line 4 (Optional)</mat-label>
              <input matInput [value]="headerConfig().addressLine4" (input)="updateHeaderConfig('addressLine4', $any($event.target).value)">
            </mat-form-field>
          </div>
          
          <div class="form-row">
            <mat-slide-toggle 
              [checked]="headerConfig().showQuoteNote" 
              (change)="updateHeaderConfig('showQuoteNote', $event.checked)">
              Show "Please quote..." note
            </mat-slide-toggle>
          </div>
          
          <div class="form-row">
            <mat-slide-toggle 
              [checked]="headerConfig().showBarcode" 
              (change)="updateHeaderConfig('showBarcode', $event.checked)">
              Show Barcode
            </mat-slide-toggle>
          </div>
        }
      </div>
    </div>
  }

  <!-- Reusable Components Panel (Collapsible) -->
  @if (showComponentsPanel) {
    <div class="components-panel">
      <div class="panel-header">
        <mat-icon>widgets</mat-icon>
        <span>Reusable Components</span>
        <span class="hint">Click a component to insert it into your content</span>
      </div>
      <div class="component-categories">
        @for (category of componentLibrary; track category.category) {
          <div class="component-category">
            <h4>
              <mat-icon>{{ category.icon }}</mat-icon>
              {{ category.category }}
            </h4>
            <div class="component-items">
              @for (item of category.items; track item.name) {
                <button 
                  mat-stroked-button 
                  class="component-item"
                  (click)="insertComponent(item)"
                  [matTooltip]="'Insert ' + item.name">
                  <mat-icon>{{ item.icon }}</mat-icon>
                  <span>{{ item.name }}</span>
                </button>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Editor Layout -->
  <div class="editor-layout">
    <!-- Left Panel - Form -->
    <div class="form-panel">
      <mat-card>
        <mat-card-header>
          <mat-icon mat-card-avatar class="header-icon">edit_note</mat-icon>
          <mat-card-title>Notice Content</mat-card-title>
          <mat-card-subtitle>Use the rich text editor to format your notice</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notice Title</mat-label>
            <input matInput [(ngModel)]="title" placeholder="e.g., Income Tax Assessment Notice">
            <mat-icon matSuffix>title</mat-icon>
          </mat-form-field>
          
          <!-- TinyMCE Rich Text Editor (Self-hosted, no API key needed) -->
          <div class="editor-wrapper">
            <label class="editor-label">Notice Content</label>
            <editor
              [(ngModel)]="content"
              [init]="editorConfig">
            </editor>
            <div class="editor-hint">
              <mat-icon>info</mat-icon>
              <span>Use double curly braces for dynamic content. Click "Variables" to see available options.</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    
    <!-- Right Panel - Preview -->
    <div class="preview-panel">
      <div class="preview-header">
        <mat-icon>visibility</mat-icon>
        <span>Document Preview</span>
        <button mat-stroked-button class="toggle-data-btn" (click)="toggleSampleData()" [matTooltip]="showSampleData ? 'Click to show variable names' : 'Click to show sample values'">
          <mat-icon>{{ showSampleData ? 'data_object' : 'text_fields' }}</mat-icon>
          {{ showSampleData ? 'Sample Data' : 'Variables' }}
        </button>
        <div class="zoom-controls">
          <button mat-icon-button (click)="zoomOut()" matTooltip="Zoom Out">
            <mat-icon>remove</mat-icon>
          </button>
          <span class="zoom-level">{{ zoom }}%</span>
          <button mat-icon-button (click)="zoomIn()" matTooltip="Zoom In">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
      <div class="preview-content a4-preview">
        <div class="pages-wrapper" [style.transform]="'scale(' + (zoom/100) + ')'" [style.transform-origin]="'top center'">
          <!-- A4 Page -->
          <div class="a4-page">
            <!-- Page Content -->
            <div class="page-content">
              <!-- IRAS Header -->
              @if (headerConfig().showHeader) {
                <div class="iras-header">
                  <div class="header-left">
                    <p class="tax-ref">Tax Reference Number: <strong>{{ headerConfig().taxRef }}</strong></p>
                    <p class="date">Date: {{ headerConfig().date }}</p>
                    @if (headerConfig().showQuoteNote) {
                      <p class="quote-note">Please quote the Tax Reference Number (e.g. NRIC, FIN etc.) in full when corresponding with us.</p>
                    }
                    <div class="taxpayer-info">
                      <p><strong>{{ headerConfig().recipientName }}</strong></p>
                      <p>{{ headerConfig().addressLine1 }}</p>
                      @if (headerConfig().addressLine2) {
                        <p>{{ headerConfig().addressLine2 }}</p>
                      }
                      @if (headerConfig().addressLine3) {
                        <p>{{ headerConfig().addressLine3 }}</p>
                      }
                      @if (headerConfig().addressLine4) {
                        <p>{{ headerConfig().addressLine4 }}</p>
                      }
                    </div>
                    @if (headerConfig().showBarcode) {
                      <div class="barcode-container">
                        <svg id="editor-barcode"></svg>
                      </div>
                    }
                  </div>
                  <div class="header-right">
                    <div class="iras-logo">
                      <img src="/assets/images/iras-logo.png" alt="IRAS Logo" class="logo-image" onerror="this.style.display='none'">
                    </div>
                  </div>
                </div>
              }
              
              <!-- Document Title -->
              @if (title()) {
                <div class="doc-title-bar">
                  {{ title() }}
                </div>
              }
              
              <!-- Content with rendered HTML and sample data -->
              <div class="doc-body" [innerHTML]="getPreviewContent()"></div>
            </div>
            
            <!-- Page Footer -->
            <div class="page-footer">
              <p>Website: <a href="#">www.iras.gov.sg</a> â€¢ myTax Portal: <a href="#">mytax.iras.gov.sg</a></p>
              <p>Tel: 6351 3551</p>
              <p class="page-number">Page 1 of 1</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
